<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Solar AR</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:ital@0;1&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --gold: #FFD166;
    --cyan: #06D6A0;
    --deep: #0A0A14;
    --glass: rgba(10, 10, 30, 0.55);
  }

  body {
    overflow: hidden;
    background: #000;
    font-family: 'Space Mono', monospace;
    color: white;
  }

  /* â”€â”€ Camera background â”€â”€ */
  #video-bg {
    position: fixed;
    inset: 0;
    width: 100%; height: 100%;
    object-fit: cover;
    z-index: 0;
    opacity: 0;
    transition: opacity 1s;
  }
  #video-bg.visible { opacity: 1; }

  /* Three.js canvas */
  #canvas {
    position: fixed;
    inset: 0;
    width: 100%; height: 100%;
    z-index: 1;
  }

  /* â”€â”€ Starfield overlay (CSS-only) â”€â”€ */
  #stars {
    position: fixed;
    inset: 0;
    z-index: 2;
    pointer-events: none;
    background: transparent;
    mix-blend-mode: screen;
  }

  /* â”€â”€ Permission screen â”€â”€ */
  #overlay {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at center, #0d0d2b 0%, #000 70%);
    padding: 40px;
    gap: 24px;
  }

  .overlay-logo {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(32px, 8vw, 64px);
    font-weight: 900;
    letter-spacing: 0.08em;
    background: linear-gradient(135deg, #fff 30%, var(--gold));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: center;
    line-height: 1.1;
  }

  .overlay-sub {
    font-size: 12px;
    color: #888;
    text-align: center;
    line-height: 1.8;
    letter-spacing: 0.05em;
    max-width: 320px;
  }

  .star-grid {
    position: absolute;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
  }
  .star-grid::before {
    content: '';
    position: absolute;
    inset: 0;
    background-image:
      radial-gradient(1px 1px at 10% 15%, white, transparent),
      radial-gradient(1px 1px at 25% 40%, white, transparent),
      radial-gradient(1.5px 1.5px at 45% 20%, white, transparent),
      radial-gradient(1px 1px at 60% 70%, white, transparent),
      radial-gradient(2px 2px at 75% 10%, #FFD166, transparent),
      radial-gradient(1px 1px at 85% 55%, white, transparent),
      radial-gradient(1px 1px at 15% 80%, white, transparent),
      radial-gradient(1.5px 1.5px at 90% 30%, white, transparent),
      radial-gradient(1px 1px at 35% 60%, white, transparent),
      radial-gradient(1px 1px at 55% 90%, white, transparent),
      radial-gradient(1px 1px at 70% 45%, white, transparent),
      radial-gradient(2px 2px at 5% 50%, #06D6A0, transparent);
    animation: twinkle 4s ease-in-out infinite alternate;
  }
  @keyframes twinkle {
    from { opacity: 0.5; }
    to   { opacity: 1; }
  }

  #start-btn {
    position: relative;
    padding: 16px 48px;
    border: none;
    border-radius: 4px;
    background: var(--gold);
    color: #000;
    font-family: 'Orbitron', sans-serif;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.15em;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    text-transform: uppercase;
  }
  #start-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(255, 209, 102, 0.4);
  }
  #start-btn:active { transform: translateY(0); }

  .permission-note {
    font-size: 10px;
    color: #444;
    text-align: center;
    letter-spacing: 0.04em;
  }

  /* â”€â”€ HUD top â”€â”€ */
  #hud-top {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.8s 0.5s;
  }
  #hud-top.visible { opacity: 1; }

  #hud-logo {
    font-family: 'Orbitron', sans-serif;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.2em;
    color: var(--gold);
  }

  #planet-label {
    font-size: 11px;
    letter-spacing: 0.12em;
    color: rgba(255,255,255,0.7);
    text-transform: uppercase;
  }

  #hint {
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    letter-spacing: 0.06em;
    font-style: italic;
  }

  /* â”€â”€ Bottom selector â”€â”€ */
  #hud-bottom {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 10;
    padding: 0 0 env(safe-area-inset-bottom, 12px);
    background: linear-gradient(to top, rgba(0,0,0,0.75) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.8s 0.6s;
  }
  #hud-bottom.visible { opacity: 1; }

  #planet-scroll {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding: 20px 20px 20px;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
  }
  #planet-scroll::-webkit-scrollbar { display: none; }

  .p-btn {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 10px 16px 10px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(10, 10, 30, 0.5);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    cursor: pointer;
    transition: all 0.2s;
    min-width: 72px;
  }
  .p-btn:hover { border-color: rgba(255,255,255,0.3); }
  .p-btn.active {
    border-color: var(--gold);
    background: rgba(255, 209, 102, 0.1);
  }

  .p-icon {
    width: 28px; height: 28px;
    border-radius: 50%;
    transition: transform 0.3s;
  }
  .p-btn.active .p-icon { transform: scale(1.2); }

  .p-name {
    font-family: 'Orbitron', sans-serif;
    font-size: 8px;
    letter-spacing: 0.1em;
    color: rgba(255,255,255,0.7);
    white-space: nowrap;
  }
  .p-btn.active .p-name { color: var(--gold); }

  /* â”€â”€ Loading spinner â”€â”€ */
  #loader {
    position: fixed;
    inset: 0;
    z-index: 50;
    display: none;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }
  #loader.show { display: flex; }
  .spinner {
    width: 40px; height: 40px;
    border: 2px solid rgba(255,255,255,0.1);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Info panel â”€â”€ */
  #info-panel {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    text-align: center;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s;
  }
  #info-panel.visible { opacity: 1; }

  #planet-big-name {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(18px, 5vw, 28px);
    font-weight: 700;
    letter-spacing: 0.15em;
    text-shadow: 0 0 30px rgba(255,255,255,0.3);
    color: white;
  }

  #planet-desc {
    font-size: 10px;
    color: rgba(255,255,255,0.5);
    letter-spacing: 0.08em;
    margin-top: 4px;
  }

  /* crosshair */
  #crosshair {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    z-index: 5;
    width: 40px; height: 40px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s;
  }
  #crosshair.visible { opacity: 0.3; }
  #crosshair::before, #crosshair::after {
    content: '';
    position: absolute;
    background: white;
  }
  #crosshair::before { width: 1px; height: 100%; left: 50%; top: 0; }
  #crosshair::after  { width: 100%; height: 1px; top: 50%; left: 0; }
</style>
</head>
<body>

<!-- Permission overlay -->
<div id="overlay">
  <div class="star-grid"></div>
  <div class="overlay-logo">SOLAR<br>AR</div>
  <p class="overlay-sub">Esplora i pianeti del sistema solare<br>in realtÃ  aumentata.<br><br>Richiede accesso a fotocamera<br>e sensori di movimento.</p>
  <button id="start-btn">AVVIA ESPLORAZIONE</button>
  <p class="permission-note">Ruota il dispositivo per girare intorno ai pianeti</p>
</div>

<!-- Loader -->
<div id="loader"><div class="spinner"></div></div>

<!-- Camera -->
<video id="video-bg" autoplay playsinline muted></video>

<!-- Three.js canvas -->
<canvas id="canvas"></canvas>

<!-- Crosshair -->
<div id="crosshair"></div>

<!-- HUD top -->
<div id="hud-top">
  <span id="hud-logo">SOLARÂ·AR</span>
  <span id="planet-label">Seleziona un pianeta</span>
  <span id="hint">trascina per orbitare</span>
</div>

<!-- Planet name overlay -->
<div id="info-panel">
  <div id="planet-big-name"></div>
  <div id="planet-desc"></div>
</div>

<!-- Bottom panel -->
<div id="hud-bottom">
  <div id="planet-scroll"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Planet data
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PLANETS = [
  {
    name: 'Sole', emoji: 'â˜€ï¸',
    key: 'sun', size: 2.2,
    color: '#FDB813', glowColor: 0xFFAA00,
    isSun: true,
    desc: 'Stella G2 Â· 1.989 Ã— 10Â³â° kg',
    tex: './textures/2k_sun.jpg'
  },
  {
    name: 'Mercurio', emoji: 'â˜¿',
    key: 'mercury', size: 0.55,
    color: '#B5B5B5',
    desc: 'Pianeta roccioso Â· Ã˜ 4.879 km',
    tex: './textures/2k_mercury.jpg'
  },
  {
    name: 'Venere', emoji: 'â™€',
    key: 'venus', size: 0.85,
    color: '#E8C880',
    desc: 'Atmosfera densa di COâ‚‚ Â· 462Â°C',
    tex: './textures/2k_venus_surface.jpg'
  },
  {
    name: 'Terra', emoji: 'ğŸŒ',
    key: 'earth', size: 0.9,
    color: '#2E86AB',
    desc: 'Casa Â· Unico pianeta con vita nota',
    tex: './textures/2k_earth_daymap.jpg'
  },
  {
    name: 'Marte', emoji: 'â™‚',
    key: 'mars', size: 0.65,
    color: '#C1440E',
    desc: 'Pianeta rosso Â· Olympus Mons 21km',
    tex: './textures/2k_mars.jpg'
  },
  {
    name: 'Giove', emoji: 'â™ƒ',
    key: 'jupiter', size: 1.7,
    color: '#C88B3A',
    desc: 'Gigante gassoso Â· 1.898 Ã— 10Â²â· kg',
    tex: './textures/2k_jupiter.jpg'
  },
  {
    name: 'Saturno', emoji: 'â™„',
    key: 'saturn', size: 1.4,
    color: '#E4D191',
    hasRings: true,
    desc: 'Anelli di ghiaccio Â· DensitÃ  < acqua',
    tex: './textures/2k_saturn.jpg',
    ringTex: './textures/2k_saturn_ring_alpha.png'
  },
  {
    name: 'Urano', emoji: 'â›¢',
    key: 'uranus', size: 1.15,
    color: '#7DE8E8',
    desc: 'Gigante ghiacciato Â· Rotazione laterale',
    tex: './textures/2k_uranus.jpg'
  },
  {
    name: 'Nettuno', emoji: 'â™†',
    key: 'neptune', size: 1.1,
    color: '#4B70DD',
    desc: 'Venti 2.100 km/h Â· Luna Tritone',
    tex: './textures/2k_neptune.jpg'
  }
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let scene, camera, renderer;
let planetGroup = null;
let currentPlanet = null;
let texCache = {};
let usingGyro = false;

// Orbit (touch/mouse)
let isDragging = false;
let prevPt = { x: 0, y: 0 };
let theta = 0.3, phi = 1.3;
let R = 5;

// Gyro
let gyroAlpha = 0, gyroBeta = 90, gyroGamma = 0;
let gyroBase = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Three.js init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initThree() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(55, innerWidth / innerHeight, 0.01, 500);
  positionCamera();

  renderer = new THREE.WebGLRenderer({
    canvas: document.getElementById('canvas'),
    alpha: true,
    antialias: true
  });
  renderer.setSize(innerWidth, innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.setClearColor(0x000000, 0);
  renderer.shadowMap.enabled = false;

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff, 0.25));
  const sun = new THREE.DirectionalLight(0xfff5e0, 1.5);
  sun.position.set(6, 4, 6);
  scene.add(sun);

  // Star particles
  addStars();

  window.addEventListener('resize', () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
  });

  animate();
}

function addStars() {
  const geo = new THREE.BufferGeometry();
  const n = 2000;
  const pos = new Float32Array(n * 3);
  const sizes = new Float32Array(n);
  for (let i = 0; i < n; i++) {
    const r = 80 + Math.random() * 120;
    const theta = Math.random() * Math.PI * 2;
    const phi = Math.acos(2 * Math.random() - 1);
    pos[i * 3]     = r * Math.sin(phi) * Math.cos(theta);
    pos[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
    pos[i * 3 + 2] = r * Math.cos(phi);
    sizes[i] = Math.random() * 1.5 + 0.5;
  }
  geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
  geo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

  const mat = new THREE.PointsMaterial({
    color: 0xffffff,
    size: 0.3,
    sizeAttenuation: true,
    transparent: true,
    opacity: 0.8
  });
  scene.add(new THREE.Points(geo, mat));
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Planet placement
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function placePlanet(p) {
  // Cleanup
  if (planetGroup) {
    planetGroup.traverse(obj => {
      if (obj.geometry) obj.geometry.dispose();
      if (obj.material) {
        if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
        else obj.material.dispose();
      }
    });
    scene.remove(planetGroup);
    planetGroup = null;
  }

  currentPlanet = p;
  //R = Math.max(3, p.size * 3.5) * (p.hasRings ? 1.8 : 1);
  R = Math.max(3, p.size * 5) * (p.hasRings ? 1.8 : 1);
  gyroBase = null; // reset gyro reference for this planet

  document.getElementById('planet-big-name').textContent = p.name.toUpperCase();
  document.getElementById('planet-desc').textContent = p.desc;
  document.getElementById('planet-label').textContent = p.name;
  document.getElementById('info-panel').classList.add('visible');

  setLoader(true);

  planetGroup = new THREE.Group();
  scene.add(planetGroup);

  // Sphere
  const geo = new THREE.SphereGeometry(p.size, 80, 80);
  const tex = await loadTex(p.tex);

  let mat;
  if (p.isSun) {
    mat = tex
      ? new THREE.MeshBasicMaterial({ map: tex })
      : new THREE.MeshBasicMaterial({ color: parseInt(p.color.replace('#',''), 16) });

    // Glow layers
    [1.08, 1.18, 1.35].forEach((scale, i) => {
      const gGeo = new THREE.SphereGeometry(p.size * scale, 32, 32);
      const gMat = new THREE.MeshBasicMaterial({
        color: p.glowColor,
        transparent: true,
        opacity: [0.18, 0.09, 0.04][i],
        side: THREE.BackSide
      });
      planetGroup.add(new THREE.Mesh(gGeo, gMat));
    });

    // Point light from sun
    const pl = new THREE.PointLight(0xFFF5E0, 2.5, 50);
    planetGroup.add(pl);
  } else {
    mat = new THREE.MeshPhongMaterial({
      map: tex || null,
      color: tex ? 0xffffff : parseInt(p.color.replace('#',''), 16),
      shininess: 25,
      specular: new THREE.Color(0x333333)
    });
  }

  const mesh = new THREE.Mesh(geo, mat);
  mesh.name = 'planet';
  planetGroup.add(mesh);

  // Saturn rings
  if (p.hasRings) {
    const inner = p.size * 1.35, outer = p.size * 2.3;
    const rGeo = new THREE.RingGeometry(inner, outer, 128);
    // Fix UVs for ring geometry
    const uv = rGeo.attributes.uv;
    const pos = rGeo.attributes.position;
    const v3 = new THREE.Vector3();
    for (let i = 0; i < pos.count; i++) {
      v3.fromBufferAttribute(pos, i);
      const len = v3.length();
      const t = (len - inner) / (outer - inner);
      uv.setXY(i, t, 1);
    }
    const ringTex = await loadTex(p.ringTex);
    const rMat = new THREE.MeshBasicMaterial({
      map: ringTex || null,
      color: ringTex ? 0xffffff : 0xC2A96B,
      side: THREE.DoubleSide,
      transparent: true,
      opacity: ringTex ? 1.0 : 0.6
    });
    const ring = new THREE.Mesh(rGeo, rMat);
    ring.rotation.x = Math.PI / 2.2;
    ring.name = 'ring';
    planetGroup.add(ring);
  }

  setLoader(false);

  // Reset view angle
  theta = 0.3;
  phi = 1.25;
  positionCamera();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Camera
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function positionCamera() {
  const x = R * Math.sin(phi) * Math.sin(theta);
  const y = R * Math.cos(phi);
  const z = R * Math.sin(phi) * Math.cos(theta);
  camera.position.set(x, y, z);
  camera.lookAt(0, 0, 0);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Texture loader with fallback
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadTex(url) {
  if (!url) return Promise.resolve(null);
  if (texCache[url] !== undefined) return Promise.resolve(texCache[url]);
  return new Promise(resolve => {
    const loader = new THREE.TextureLoader();
    loader.crossOrigin = 'anonymous';
    loader.load(url,
      t => { texCache[url] = t; resolve(t); },
      undefined,
      () => { texCache[url] = null; resolve(null); }
    );
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Animation loop
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animate() {
  requestAnimationFrame(animate);

  if (planetGroup) {
    const planet = planetGroup.getObjectByName('planet');
    if (planet) {
      planet.rotation.y += currentPlanet?.isSun ? 0.001 : 0.003;
    }

    // Gyro camera
    if (usingGyro && !isDragging) {
      if (gyroBase === null) {
        gyroBase = { a: gyroAlpha, b: gyroBeta };
      }
      const da = THREE.MathUtils.degToRad(gyroAlpha - gyroBase.a);
      const db = THREE.MathUtils.degToRad(gyroBeta - gyroBase.b);
      theta = 0.3 - da;
      phi = Math.max(0.15, Math.min(Math.PI - 0.15, 1.25 - db * 0.5));
    }

    positionCamera();
  }

  renderer.render(scene, camera);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Input: touch + mouse
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupInput() {
  const canvas = document.getElementById('canvas');

  // Touch
  canvas.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
      isDragging = true;
      prevPt = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }
  }, { passive: true });

  canvas.addEventListener('touchmove', e => {
    if (!isDragging || !currentPlanet) return;
    const dx = e.touches[0].clientX - prevPt.x;
    const dy = e.touches[0].clientY - prevPt.y;
    theta -= dx * 0.008;
    phi = Math.max(0.15, Math.min(Math.PI - 0.15, phi + dy * 0.008));
    prevPt = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    // Update gyroBase to avoid snap when releasing
    if (usingGyro) gyroBase = { a: gyroAlpha, b: gyroBeta };
  }, { passive: true });

  canvas.addEventListener('touchend', () => { isDragging = false; });

  // Mouse
  canvas.addEventListener('mousedown', e => {
    isDragging = true;
    prevPt = { x: e.clientX, y: e.clientY };
  });
  canvas.addEventListener('mousemove', e => {
    if (!isDragging || !currentPlanet) return;
    const dx = e.clientX - prevPt.x;
    const dy = e.clientY - prevPt.y;
    theta -= dx * 0.008;
    phi = Math.max(0.15, Math.min(Math.PI - 0.15, phi + dy * 0.008));
    prevPt = { x: e.clientX, y: e.clientY };
    if (usingGyro) gyroBase = { a: gyroAlpha, b: gyroBeta };
  });
  canvas.addEventListener('mouseup', () => { isDragging = false; });
  canvas.addEventListener('mouseleave', () => { isDragging = false; });

  // Scroll to zoom
  canvas.addEventListener('wheel', e => {
    // No-op for now (orbit radius fixed)
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Gyroscope / DeviceOrientation
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupGyro() {
  const onOrientation = e => {
    if (e.alpha === null) return;
    gyroAlpha = e.alpha;
    gyroBeta  = e.beta;
    gyroGamma = e.gamma;
    if (!usingGyro) {
      usingGyro = true;
      document.getElementById('hint').textContent = 'ruota il dispositivo per orbitare';
    }
  };

  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    // iOS 13+: permission required, call after user gesture (start-btn already did it)
    DeviceOrientationEvent.requestPermission()
      .then(res => { if (res === 'granted') window.addEventListener('deviceorientation', onOrientation); })
      .catch(() => {});
  } else {
    window.addEventListener('deviceorientation', onOrientation);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Camera stream
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCamera() {
  const video = document.getElementById('video-bg');
  const constraints = [
    { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } }, audio: false },
    { video: { facingMode: 'user' }, audio: false },
    { video: true, audio: false }
  ];
  for (const c of constraints) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia(c);
      video.srcObject = stream;
      video.onloadedmetadata = () => video.classList.add('visible');
      return;
    } catch (_) {}
  }
  // No camera â€” dark background is fine
  document.body.style.background = 'radial-gradient(ellipse at center, #0d0d2b, #000)';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Planet selector UI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildUI() {
  const scroll = document.getElementById('planet-scroll');

  PLANETS.forEach(p => {
    const btn = document.createElement('button');
    btn.className = 'p-btn';
    btn.dataset.key = p.key;

    // Mini color swatch icon
    const icon = document.createElement('div');
    icon.className = 'p-icon';
    icon.style.background = p.color;
    if (p.isSun) {
      icon.style.boxShadow = `0 0 12px 4px ${p.color}88`;
    }

    const name = document.createElement('span');
    name.className = 'p-name';
    name.textContent = p.name.toUpperCase();

    btn.append(icon, name);
    btn.onclick = () => {
      document.querySelectorAll('.p-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      placePlanet(p);
    };
    scroll.appendChild(btn);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Helpers
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoader(v) {
  document.getElementById('loader').classList.toggle('show', v);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Bootstrap
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('start-btn').onclick = async () => {
  document.getElementById('overlay').style.opacity = '0';
  document.getElementById('overlay').style.pointerEvents = 'none';
  setTimeout(() => document.getElementById('overlay').remove(), 800);

  await startCamera();
  initThree();
  setupInput();
  setupGyro();
  buildUI();

  document.getElementById('hud-top').classList.add('visible');
  document.getElementById('hud-bottom').classList.add('visible');
  document.getElementById('crosshair').classList.add('visible');
};
</script>
</body>
</html>